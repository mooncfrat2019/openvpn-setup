---
- name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞ OpenVPN
  hosts: all
  become: yes
  vars:
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    new_client_name: "client2"  # –ò–º—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
    easyrsa_dir: "/opt/easy-rsa"
    openvpn_dir: "/etc/openvpn"
    server_dir: "{{ openvpn_dir }}/server"

    # –î–∞–Ω–Ω—ã–µ CA (–¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏)
    ca_country: "RU"
    ca_province: "Moscow"
    ca_city: "Moscow"
    ca_org: "MyCompany"
    ca_email: "admin@mycompany.com"
    ca_ou: "IT"

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
    vpn_server_ip: "{{ ansible_default_ipv4.address }}"
    vpn_port: 1194
    vpn_proto: "udp"

  tasks:
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è CA
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è CA
      stat:
        path: "{{ easyrsa_dir }}/pki/ca.crt"
      register: ca_check

    - name: –í—ã—Ö–æ–¥ –µ—Å–ª–∏ CA –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      fail:
        msg: "CA –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ {{ easyrsa_dir }}/pki/. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π–±—É–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ OpenVPN."
      when: not ca_check.stat.exists

    # 2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
      command:
        cmd: ./easyrsa --batch gen-req {{ new_client_name }} nopass
        chdir: "{{ easyrsa_dir }}"
      args:
        creates: "{{ easyrsa_dir }}/pki/private/{{ new_client_name }}.key"
      register: gen_req
      failed_when: gen_req.rc != 0 and "'already exists' not in gen_req.stdout"

    - name: –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      command:
        cmd: ./easyrsa --batch sign-req client {{ new_client_name }}
        chdir: "{{ easyrsa_dir }}"
      args:
        creates: "{{ easyrsa_dir }}/pki/issued/{{ new_client_name }}.crt"
      register: sign_req
      failed_when: sign_req.rc != 0 and "'already exists' not in sign_req.stdout"

    # 3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–æ–≤
    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      shell: cat {{ easyrsa_dir }}/pki/ca.crt
      register: ca_content
      changed_when: false

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      shell: cat {{ easyrsa_dir }}/pki/issued/{{ new_client_name }}.crt
      register: cert_content
      changed_when: false

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª—é—á–∞
      shell: cat {{ easyrsa_dir }}/pki/private/{{ new_client_name }}.key
      register: key_content
      changed_when: false

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ TLS –∫–ª—é—á–∞
      shell: cat {{ easyrsa_dir }}/ta.key
      register: ta_content
      changed_when: false

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      shell: |
        grep -E "^(cipher|auth|proto|port)" {{ server_dir }}/server.conf || true
      register: server_config
      changed_when: false

    # 4. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ —Å–µ—Ä–≤–µ—Ä–∞
    - name: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
      set_fact:
        vpn_cipher: "{{ server_config.stdout_lines | select('match', '^cipher') | list | first | default('AES-256-GCM') | regex_replace('^cipher\\s+', '') }}"
        vpn_auth: "{{ server_config.stdout_lines | select('match', '^auth') | list | first | default('SHA512') | regex_replace('^auth\\s+', '') }}"
        vpn_proto: "{{ server_config.stdout_lines | select('match', '^proto') | list | first | default('udp') | regex_replace('^proto\\s+', '') }}"
        vpn_port: "{{ server_config.stdout_lines | select('match', '^port') | list | first | default('1194') | regex_replace('^port\\s+', '') }}"

    # 5. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ OVPN —Ñ–∞–π–ª–∞
      copy:
        dest: "/home/{{ ansible_user }}/{{ new_client_name }}.ovpn"
        content: |
          # OpenVPN Client Configuration for {{ new_client_name }}
          # Generated: {{ ansible_date_time.date }}
          # Server: {{ vpn_server_ip }}
          
          client
          dev tun
          proto {{ vpn_proto }}
          remote {{ vpn_server_ip }} {{ vpn_port }}
          resolv-retry infinite
          nobind
          persist-key
          persist-tun
          remote-cert-tls server
          cipher {{ vpn_cipher }}
          auth {{ vpn_auth }}
          verb 3
          auth-nocache
          
          <ca>
          </ca>
          
          <cert>
          </cert>
          
          <key>
          </key>
          
          key-direction 1
          <tls-auth>
          </tls-auth>
        mode: '0600'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    # 6. –í—Å—Ç–∞–≤–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∏ –∫–ª—é—á–µ–π
    - name: –í—Å—Ç–∞–≤–∫–∞ CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      lineinfile:
        path: "/home/{{ ansible_user }}/{{ new_client_name }}.ovpn"
        insertafter: '<ca>'
        line: "{{ ca_content.stdout }}"
        backup: yes

    - name: –í—Å—Ç–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      lineinfile:
        path: "/home/{{ ansible_user }}/{{ new_client_name }}.ovpn"
        insertafter: '<cert>'
        line: "{{ cert_content.stdout }}"
        backup: yes

    - name: –í—Å—Ç–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª—é—á–∞
      lineinfile:
        path: "/home/{{ ansible_user }}/{{ new_client_name }}.ovpn"
        insertafter: '<key>'
        line: "{{ key_content.stdout }}"
        backup: yes

    - name: –í—Å—Ç–∞–≤–∫–∞ TLS –∫–ª—é—á–∞
      lineinfile:
        path: "/home/{{ ansible_user }}/{{ new_client_name }}.ovpn"
        insertafter: '<tls-auth>'
        line: "{{ ta_content.stdout }}"
        backup: yes

    # 10. –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    - name: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
      debug:
        msg: |
          ‚úÖ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ñ–∞–π–ª OpenVPN —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!
          
          üìÅ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª: /home/{{ ansible_user }}/{{ new_client_name }}.ovpn
          üì¶ –ê—Ä—Ö–∏–≤: /home/{{ ansible_user }}/{{ new_client_name }}-config.zip
          
          üåê –°–µ—Ä–≤–µ—Ä: {{ vpn_server_ip }}
          üö™ –ü–æ—Ä—Ç: {{ vpn_port }}
          üîê –ü—Ä–æ—Ç–æ–∫–æ–ª: {{ vpn_proto }}
          üîë –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: {{ vpn_cipher }}/{{ vpn_auth }}
          
          üìã –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
          1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª {{ new_client_name }}.ovpn –Ω–∞ –∫–ª–∏–µ–Ω—Ç
          2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ OpenVPN –∫–ª–∏–µ–Ω—Ç
          3. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .ovpn
          4. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
          
          ‚ö†Ô∏è  –§–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏! –•—Ä–∞–Ω–∏—Ç–µ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!