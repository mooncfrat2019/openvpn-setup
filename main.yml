---
- name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ OpenVPN —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ Ubuntu 24.04
  hosts: all
  become: yes
  vars:
    vpn_server_ip: "{{ ansible_default_ipv4.address }}"
    vpn_port: 1194
    vpn_proto: udp
    vpn_network: "10.8.0.0"
    vpn_netmask: "255.255.255.0"
    vpn_dns: "8.8.8.8"

    easyrsa_dir: "/opt/easy-rsa"
    openvpn_dir: "/etc/openvpn"
    server_dir: "{{ openvpn_dir }}/server"

    ca_country: "RU"
    ca_province: "Moscow"
    ca_city: "Moscow"
    ca_org: "MyCompany"
    ca_email: "admin@mycompany.com"
    ca_ou: "IT"

    server_name: "server"
    client_name: "client1"

  tasks:
    # 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
    - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
      apt:
        name:
          - openvpn
          - easy-rsa
          - openssl
        state: present

    # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ server_dir }}"
        - "{{ easyrsa_dir }}"

    # 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ easy-rsa —Ñ–∞–π–ª–æ–≤
    - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Easy-RSA —Ñ–∞–π–ª–æ–≤
      shell: |
        cp -r /usr/share/easy-rsa/* {{ easyrsa_dir }}/
        chmod 755 {{ easyrsa_dir }}/*
      args:
        creates: "{{ easyrsa_dir }}/easyrsa"

    - name: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ easyrsa
      file:
        src: "{{ easyrsa_dir }}/easyrsa"
        dest: "/usr/local/bin/easyrsa"
        state: link

    # 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ easy-rsa —Å —É—Å–∏–ª–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
    - name: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ vars
      copy:
        dest: "{{ easyrsa_dir }}/vars"
        content: |
          # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Ubuntu 24.04
          set_var EASYRSA_REQ_COUNTRY    "{{ ca_country }}"
          set_var EASYRSA_REQ_PROVINCE   "{{ ca_province }}"
          set_var EASYRSA_REQ_CITY       "{{ ca_city }}"
          set_var EASYRSA_REQ_ORG        "{{ ca_org }}"
          set_var EASYRSA_REQ_EMAIL      "{{ ca_email }}"
          set_var EASYRSA_REQ_OU         "{{ ca_ou }}"
          set_var EASYRSA_ALGO           "ec"           # –≠–ª–ª–∏–ø—Ç–∏—á–µ—Å–∫–∏–µ –∫—Ä–∏–≤—ã–µ - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–µ–µ RSA
          set_var EASYRSA_CURVE          "secp521r1"    # –ö—Ä–∏–≤–∞—è —Å 521-–±–∏—Ç–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
          set_var EASYRSA_DIGEST         "sha512"       # SHA512 –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          set_var EASYRSA_KEY_SIZE       4096           # –î–ª—è RSA –±—ã–ª –±—ã 4096, –¥–ª—è EC –Ω–µ –Ω—É–∂–Ω–æ
          set_var EASYRSA_BATCH          "yes"
          set_var EASYRSA_CA_EXPIRE      3650
          set_var EASYRSA_CERT_EXPIRE    825            # 2 –≥–æ–¥–∞ + 95 –¥–Ω–µ–π –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          set_var EASYRSA_CRL_DAYS       180
          set_var EASYRSA_NS_SUPPORT     "no"
          set_var EASYRSA_NS_COMMENT     "OpenVPN Generated Certificate"
        mode: '0644'

    # 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PKI
    - name: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PKI
      command:
        cmd: ./easyrsa init-pki
        chdir: "{{ easyrsa_dir }}"
      args:
        creates: "{{ easyrsa_dir }}/pki"

    # 6. –°–æ–∑–¥–∞–Ω–∏–µ CA —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞
    - name: –°–æ–∑–¥–∞–Ω–∏–µ CA
      shell: |
        cd {{ easyrsa_dir }}
        ./easyrsa --use-algo=ec --curve=secp521r1 --digest=sha512 build-ca nopass <<EOF
        {{ ca_org }}
        EOF
      args:
        creates: "{{ easyrsa_dir }}/pki/ca.crt"
      register: ca_result
      failed_when: ca_result.rc != 0 and "'already exists' not in ca_result.stdout"

    # 7. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è CA –µ—Å–ª–∏ EC –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    - name: –°–æ–∑–¥–∞–Ω–∏–µ CA —Å RSA (fallback)
      when: ca_result is failed
      shell: |
        cd {{ easyrsa_dir }}
        ./easyrsa --use-algo=rsa --keysize=4096 --digest=sha512 build-ca nopass <<EOF
        {{ ca_org }}
        EOF
      args:
        creates: "{{ easyrsa_dir }}/pki/ca.crt"

    # 8. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    - name: –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
      shell: |
        cd {{ easyrsa_dir }}
        ./easyrsa --digest=sha512 gen-req {{ server_name }} nopass
      args:
        creates: "{{ easyrsa_dir }}/pki/private/{{ server_name }}.key"

    - name: –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      shell: |
        cd {{ easyrsa_dir }}
        ./easyrsa --digest=sha512 sign-req server {{ server_name }}
      args:
        creates: "{{ easyrsa_dir }}/pki/issued/{{ server_name }}.crt"

    # 9. –°–æ–∑–¥–∞–Ω–∏–µ DH –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
    - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è DH –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      shell: |
        cd {{ easyrsa_dir }}
        echo "–≥–µ–Ω–µ—Ä–∞—Ü–∏—è DH –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ 2048 –±–∏—Ç..."
        openssl dhparam -out pki/dh.pem 2048 -dsaparam
        echo "DH –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!"
      args:
        creates: "{{ easyrsa_dir }}/pki/dh.pem"

    # 10. –°–æ–∑–¥–∞–Ω–∏–µ TLS –∫–ª—é—á–∞
    - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è TLS –∫–ª—é—á–∞
      command:
        cmd: openvpn --genkey secret ta.key
        chdir: "{{ easyrsa_dir }}"
      args:
        creates: "{{ easyrsa_dir }}/ta.key"

    # 11. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
      shell: |
        cd {{ easyrsa_dir }}
        ./easyrsa --digest=sha512 gen-req {{ client_name }} nopass
      args:
        creates: "{{ easyrsa_dir }}/pki/private/{{ client_name }}.key"

    - name: –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      shell: |
        cd {{ easyrsa_dir }}
        ./easyrsa --digest=sha512 sign-req client {{ client_name }}
      args:
        creates: "{{ easyrsa_dir }}/pki/issued/{{ client_name }}.crt"

    # 12. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
      copy:
        src: "{{ item.src }}"
        dest: "{{ server_dir }}/{{ item.dest }}"
        mode: '0644'
        remote_src: yes
      loop:
        - { src: '{{ easyrsa_dir }}/pki/ca.crt', dest: 'ca.crt' }
        - { src: '{{ easyrsa_dir }}/pki/issued/{{ server_name }}.crt', dest: '{{ server_name }}.crt' }
        - { src: '{{ easyrsa_dir }}/pki/private/{{ server_name }}.key', dest: '{{ server_name }}.key' }
        - { src: '{{ easyrsa_dir }}/pki/dh.pem', dest: 'dh.pem' }
        - { src: '{{ easyrsa_dir }}/ta.key', dest: 'ta.key' }

    # 13. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞ —Å —É—Å–∏–ª–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞
      copy:
        dest: "{{ server_dir }}/server.conf"
        content: |
          # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          port {{ vpn_port }}
          proto {{ vpn_proto }}
          dev tun
          
          # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –∫–ª—é—á–∏
          ca ca.crt
          cert {{ server_name }}.crt
          key {{ server_name }}.key
          dh dh.pem
          
          # –°–µ—Ç—å
          server {{ vpn_network }} {{ vpn_netmask }}
          ifconfig-pool-persist ipp.txt
          
          # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          push "redirect-gateway def1 bypass-dhcp"
          push "dhcp-option DNS {{ vpn_dns }}"
          push "dhcp-option DNS 1.1.1.1"
          
          # –£—Å–∏–ª–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
          tls-auth ta.key 0
          tls-version-min 1.2
          tls-cipher TLS-ECDHE-ECDSA-WITH-AES-256-GCM-SHA384:TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384
          cipher AES-256-GCM
          auth SHA512  # –ò—Å–ø–æ–ª—å–∑—É–µ–º SHA512 –≤–º–µ—Å—Ç–æ SHA256
          data-ciphers AES-256-GCM:AES-256-CBC
          data-ciphers-fallback AES-256-CBC
          
          # Perfect Forward Secrecy
          reneg-sec 3600
          
          # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
          keepalive 10 120
          persist-key
          persist-tun
          
          # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
          status openvpn-status.log
          log /var/log/openvpn.log
          verb 3
          
          # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
          user nobody
          group nogroup
          auth-nocache
          tls-server
          
          # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          explicit-exit-notify 1
        mode: '0644'

    # 14. –í–∫–ª—é—á–µ–Ω–∏–µ IP —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞
    - name: –í–∫–ª—é—á–µ–Ω–∏–µ IP —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞
      sysctl:
        name: net.ipv4.ip_forward
        value: 1
        sysctl_set: yes
        state: present
        reload: yes

    # 15. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–µ—Ä–≤–æ–ª–∞
    - name: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ—Ä—Ç–∞ OpenVPN
      ufw:
        rule: allow
        port: "{{ vpn_port }}"
        proto: "{{ vpn_proto }}"

    - name: –í–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–≤–∞—Ä–¥–∏–Ω–≥–∞ –≤ UFW
      lineinfile:
        path: /etc/default/ufw
        regexp: '^DEFAULT_FORWARD_POLICY='
        line: 'DEFAULT_FORWARD_POLICY="ACCEPT"'

    # 16. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
    - name: –ó–∞–ø—É—Å–∫ OpenVPN —Å–µ—Ä–≤–µ—Ä–∞
      systemd:
        name: openvpn-server@server
        state: started
        enabled: yes
        daemon_reload: yes

    # 17. –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    - name: –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞
      copy:
        dest: "/home/{{ ansible_user }}/{{ client_name }}.ovpn"
        content: |
          client
          dev tun
          proto {{ vpn_proto }}
          remote {{ vpn_server_ip }} {{ vpn_port }}
          resolv-retry infinite
          nobind
          persist-key
          persist-tun
          remote-cert-tls server
          cipher AES-256-GCM
          auth SHA512
          tls-version-min 1.2
          tls-cipher TLS-ECDHE-ECDSA-WITH-AES-256-GCM-SHA384:TLS-ECDHE-RSA-WITH-AES-256-GCM-SHA384
          verb 3
          auth-nocache
          
          <ca>
          </ca>
          
          <cert>
          </cert>
          
          <key>
          </key>
          
          key-direction 1
          <tls-auth>
          </tls-auth>
        mode: '0600'

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      shell: cat {{ easyrsa_dir }}/pki/ca.crt
      register: ca_content

    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ CA —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ñ–∞–π–ª
      lineinfile:
        path: "/home/{{ ansible_user }}/{{ client_name }}.ovpn"
        insertafter: '<ca>'
        line: "{{ ca_content.stdout }}"

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      shell: cat {{ easyrsa_dir }}/pki/issued/{{ client_name }}.crt
      register: cert_content

    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
      lineinfile:
        path: "/home/{{ ansible_user }}/{{ client_name }}.ovpn"
        insertafter: '<cert>'
        line: "{{ cert_content.stdout }}"

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª—é—á–∞
      shell: cat {{ easyrsa_dir }}/pki/private/{{ client_name }}.key
      register: key_content

    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–ª—é—á–∞
      lineinfile:
        path: "/home/{{ ansible_user }}/{{ client_name }}.ovpn"
        insertafter: '<key>'
        line: "{{ key_content.stdout }}"

    - name: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ TLS –∫–ª—é—á–∞
      shell: cat {{ easyrsa_dir }}/ta.key
      register: ta_content

    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ TLS –∫–ª—é—á–∞
      lineinfile:
        path: "/home/{{ ansible_user }}/{{ client_name }}.ovpn"
        insertafter: '<tls-auth>'
        line: "{{ ta_content.stdout }}"

    # 18. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
      shell: |
        openssl x509 -in {{ easyrsa_dir }}/pki/ca.crt -text -noout | grep -E "Signature Algorithm|Public Key Algorithm"
      register: cert_check

    - name: –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      debug:
        msg: |
          ‚úÖ OpenVPN —Å–µ—Ä–≤–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å —É—Å–∏–ª–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é!
          
          üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤:
          {{ cert_check.stdout }}
          
          üìÅ –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ñ–∞–π–ª: /home/{{ ansible_user }}/{{ client_name }}.ovpn
          üåê IP —Å–µ—Ä–≤–µ—Ä–∞: {{ vpn_server_ip }}
          üö™ –ü–æ—Ä—Ç: {{ vpn_port }}
          üõ°Ô∏è  –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã:
            - –•—ç—à: SHA512 (—É—Å–∏–ª–µ–Ω–Ω—ã–π)
            - –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ: AES-256-GCM
            - –ö—Ä–∏–≤—ã–µ: secp521r1 (EC) –∏–ª–∏ RSA 4096
            - TLS: –≤–µ—Ä—Å–∏—è 1.2+
          
          üìã –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
          1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª {{ client_name }}.ovpn –Ω–∞ –∫–ª–∏–µ–Ω—Ç
          2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ OpenVPN –∫–ª–∏–µ–Ω—Ç
          3. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .ovpn
          4. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É